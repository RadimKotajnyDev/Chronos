@page "/dig/{Id}"
@inject HttpClient Http
@using System.Net

<PageTitle>Chronos - Dig</PageTitle>

<div class="min-h-screen flex justify-center pt-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-8 text-center">
        
        @if (isLoading)
        {
            <div>
                <h2 class="text-xl font-semibold text-gray-800">Digging through data...</h2>
                <p class="text-gray-600">Please wait.</p>
            </div>
        }
        else if (capsule != null)
        {
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">Capsule found!</h1>
                <p class="text-sm text-gray-500">Created: @capsule.CreatedAt.ToLocalTime().ToString("g")</p>
                <div class="mt-6 bg-slate-100 text-slate-800 italic rounded-md p-4 whitespace-pre-wrap text-left">
                    @capsule.Message
                </div>
                <a href="/" class="inline-block mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Bury another</a>
            </div>
        }
        else if (isTooEarly)
        {
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">Locked</h1>
                <p class="text-gray-600">This capsule is scheduled to open in the future.</p>
                
                <div class="mt-6 p-4 rounded-md border-2 border-dashed border-orange-500 bg-orange-50 text-left">
                    <h3 class="text-orange-700 font-semibold">Do you have an emergency key?</h3>
                    <input @bind="overrideInput" placeholder="Enter GUID key..."
                           class="mt-3 w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                    <button @onclick="TryUnlock"
                            class="mt-3 w-full bg-orange-600 hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-md">Force unlock</button>
                    @if (overrideError != null)
                    {
                        <p class="text-red-600 font-semibold mt-2">@overrideError</p>
                    }
                </div>
                <div class="mt-4">
                    <a href="/" class="text-sky-600 hover:underline">Back to home</a>
                </div>
            </div>
        }
        else
        {
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">404</h1>
                <p class="text-gray-600">This capsule does not exist or was deleted.</p>
                <a href="/" class="inline-block mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Back</a>
            </div>
        }

    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; }

    private DigResponseDto? capsule;
    private bool isLoading = true;
    private bool isTooEarly = false;
    private string overrideInput = "";
    private string? overrideError;

    protected override async Task OnInitializedAsync()
    {
        await LoadCapsule(null);
    }

    private async Task TryUnlock()
    {
        if (string.IsNullOrWhiteSpace(overrideInput)) return;
        overrideError = null;
        await LoadCapsule(overrideInput);
    }

    private async Task LoadCapsule(string? key)
    {
        isLoading = true;
        isTooEarly = false;

        try
        {
            var url = $"/api/capsules/dig/{Id}";
            if (!string.IsNullOrEmpty(key))
            {
                url += $"?overriderId={key}";
            }

            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                capsule = await response.Content.ReadFromJsonAsync<DigResponseDto>();
            }
            else
            {
                if (response.StatusCode == HttpStatusCode.NotFound)
                {
                    capsule = null;
                }
                else 
                {
                    isTooEarly = true;
                    if (key != null) overrideError = "Invalid key!";
                }
            }
        }
        catch (Exception)
        {
            capsule = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    public class DigResponseDto
    {
        public string Message { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
