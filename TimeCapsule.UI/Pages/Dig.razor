@page "/dig/{Id}"
@inject HttpClient Http
@using System.Net

<PageTitle>Chronos - Vykop√°n√≠</PageTitle>

<div class="flex justify-center pt-12 font-sans">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-[500px] text-center">
        
        @if (isLoading)
        {
            <div>
                <h2 class="mt-0 text-[#333]">‚õèÔ∏è Kopu v datech...</h2>
                <p>Pros√≠m ƒçekej.</p>
            </div>
        }
        else if (capsule != null)
        {
            /* --- √öSPƒöCH: KAPSLE ODEMƒåENA --- */
            <div>
                <h1 class="mt-0 text-[#333]">üéâ Kapsle nalezena!</h1>
                <p class="text-[#888] text-sm">Vytvo≈ôeno: @capsule.CreatedAt.ToLocalTime().ToString("g")</p>
                <div class="bg-[#f0f4f8] p-6 rounded-lg text-xl text-[#2c3e50] my-6 italic whitespace-pre-wrap">
                    @capsule.Message
                </div>
                <a href="/" class="inline-block py-2.5 px-5 rounded-md no-underline cursor-pointer border-0 mt-2.5 bg-[#95a5a6] text-white">Zakopat dal≈°√≠</a>
            </div>
        }
        else if (isTooEarly)
        {
            /* --- CHYBA: JE≈†Tƒö JE BRZY + OVERRIDE --- */
            <div>
                <h1 class="mt-0 text-[#333]">üîí Zamƒçeno</h1>
                <p>Tato kapsle se m√° otev≈ô√≠t a≈æ v budoucnosti.</p>
                
                <div class="mt-8 p-6 border-2 border-dashed border-[#e67e22] rounded-lg bg-[#fdf5e6]">
                    <h3 class="mt-0 text-[#d35400]">M√°≈° nouzov√Ω kl√≠ƒç?</h3>
                    <input @bind="overrideInput" class="w-full p-2.5 mb-2.5 box-border border border-[#ccc] rounded" placeholder="Vlo≈æ GUID kl√≠ƒç..." />
                    <button @onclick="TryUnlock" class="inline-block py-2.5 px-5 rounded-md no-underline cursor-pointer border-0 mt-2.5 bg-[#e67e22] text-white w-full font-bold">Odemknout n√°sil√≠m üîì</button>
                    @if (overrideError != null)
                    {
                        <p class="text-red-600 mt-1.5 font-bold">@overrideError</p>
                    }
                </div>
                <br/>
                <a href="/" class="text-[#3498db] no-underline inline-block mt-4">Zpƒõt na hlavn√≠ str√°nku</a>
            </div>
        }
        else
        {
            /* --- CHYBA: 404 NEEXISTUJE --- */
            <div>
                <h1 class="mt-0 text-[#333]">‚ùì 404</h1>
                <p>Tato kapsle neexistuje nebo byla zniƒçena.</p>
                <a href="/" class="inline-block py-2.5 px-5 rounded-md no-underline cursor-pointer border-0 mt-2.5 bg-[#95a5a6] text-white">Zpƒõt</a>
            </div>
        }

    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; }

    private DigResponseDto? capsule;
    private bool isLoading = true;
    private bool isTooEarly = false;
    private string overrideInput = "";
    private string? overrideError;

    protected override async Task OnInitializedAsync()
    {
        await LoadCapsule(null);
    }

    private async Task TryUnlock()
    {
        if (string.IsNullOrWhiteSpace(overrideInput)) return;
        overrideError = null;
        await LoadCapsule(overrideInput);
    }

    private async Task LoadCapsule(string? key)
    {
        isLoading = true;
        isTooEarly = false;

        try
        {
            var url = $"/api/capsules/dig/{Id}";
            if (!string.IsNullOrEmpty(key))
            {
                url += $"?overriderId={key}";
            }

            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                capsule = await response.Content.ReadFromJsonAsync<DigResponseDto>();
            }
            else
            {
                // Pokud server vr√°t√≠ chybu, zjist√≠me jakou
                if (response.StatusCode == HttpStatusCode.NotFound)
                {
                    capsule = null; // 404
                }
                else 
                {
                    // P≈ôedpokl√°d√°me, ≈æe chyba 500 nebo 400 znamen√° "Je≈°tƒõ je brzy"
                    // (Tvoje ThrowError ve FastEndpoints vrac√≠ mysl√≠m 400 nebo 500)
                    isTooEarly = true;
                    if (key != null) overrideError = "Neplatn√Ω kl√≠ƒç!";
                }
            }
        }
        catch (Exception)
        {
            // Fallback error
            capsule = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    public class DigResponseDto
    {
        public string Message { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}

