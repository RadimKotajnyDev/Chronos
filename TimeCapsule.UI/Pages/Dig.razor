@page "/dig/{Id}"
@inject HttpClient Http
@using System.Net

<PageTitle>Chronos - Vykop√°n√≠</PageTitle>

<div class="min-h-screen flex justify-center pt-12 px-4 sm:px-6 lg:px-8">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg p-8 text-center">
        
        @if (isLoading)
        {
            <div>
                <h2 class="text-xl font-semibold text-gray-800">‚õèÔ∏è Kopu v datech...</h2>
                <p class="text-gray-600">Pros√≠m ƒçekej.</p>
            </div>
        }
        else if (capsule != null)
        {
            /* --- √öSPƒöCH: KAPSLE ODEMƒåENA --- */
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">üéâ Kapsle nalezena!</h1>
                <p class="text-sm text-gray-500">Vytvo≈ôeno: @capsule.CreatedAt.ToLocalTime().ToString("g")</p>
                <div class="mt-6 bg-slate-100 text-slate-800 italic rounded-md p-4 whitespace-pre-wrap text-left">
                    @capsule.Message
                </div>
                <a href="/" class="inline-block mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Zakopat dal≈°√≠</a>
            </div>
        }
        else if (isTooEarly)
        {
            /* --- CHYBA: JE≈†Tƒö JE BRZY + OVERRIDE --- */
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">üîí Zamƒçeno</h1>
                <p class="text-gray-600">Tato kapsle se m√° otev≈ô√≠t a≈æ v budoucnosti.</p>
                
                <div class="mt-6 p-4 rounded-md border-2 border-dashed border-orange-500 bg-orange-50 text-left">
                    <h3 class="text-orange-700 font-semibold">M√°≈° nouzov√Ω kl√≠ƒç?</h3>
                    <input @bind="overrideInput" placeholder="Vlo≈æ GUID kl√≠ƒç..."
                           class="mt-3 w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                    <button @onclick="TryUnlock"
                            class="mt-3 w-full bg-orange-600 hover:bg-orange-700 text-white font-bold px-4 py-2 rounded-md">Odemknout n√°sil√≠m üîì</button>
                    @if (overrideError != null)
                    {
                        <p class="text-red-600 font-semibold mt-2">@overrideError</p>
                    }
                </div>
                <div class="mt-4">
                    <a href="/" class="text-sky-600 hover:underline">Zpƒõt na hlavn√≠ str√°nku</a>
                </div>
            </div>
        }
        else
        {
            /* --- CHYBA: 404 NEEXISTUJE --- */
            <div>
                <h1 class="mt-0 text-2xl font-bold text-gray-800">‚ùì 404</h1>
                <p class="text-gray-600">Tato kapsle neexistuje nebo byla zniƒçena.</p>
                <a href="/" class="inline-block mt-4 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Zpƒõt</a>
            </div>
        }

    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; }

    private DigResponseDto? capsule;
    private bool isLoading = true;
    private bool isTooEarly = false;
    private string overrideInput = "";
    private string? overrideError;

    protected override async Task OnInitializedAsync()
    {
        await LoadCapsule(null);
    }

    private async Task TryUnlock()
    {
        if (string.IsNullOrWhiteSpace(overrideInput)) return;
        overrideError = null;
        await LoadCapsule(overrideInput);
    }

    private async Task LoadCapsule(string? key)
    {
        isLoading = true;
        isTooEarly = false;

        try
        {
            var url = $"/api/capsules/dig/{Id}";
            if (!string.IsNullOrEmpty(key))
            {
                url += $"?overriderId={key}";
            }

            var response = await Http.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                capsule = await response.Content.ReadFromJsonAsync<DigResponseDto>();
            }
            else
            {
                // Pokud server vr√°t√≠ chybu, zjist√≠me jakou
                if (response.StatusCode == HttpStatusCode.NotFound)
                {
                    capsule = null; // 404
                }
                else 
                {
                    // P≈ôedpokl√°d√°me, ≈æe chyba 500 nebo 400 znamen√° "Je≈°tƒõ je brzy"
                    // (Tvoje ThrowError ve FastEndpoints vrac√≠ mysl√≠m 400 nebo 500)
                    isTooEarly = true;
                    if (key != null) overrideError = "Neplatn√Ω kl√≠ƒç!";
                }
            }
        }
        catch (Exception)
        {
            // Fallback error
            capsule = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    public class DigResponseDto
    {
        public string Message { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}
